<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish Speech Communication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #FFFFFF;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            padding: 20px;
        }
        
        .svg-filters {
            position: absolute;
            width: 0;
            height: 0;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100%;
            max-width: 900px;
            /* Changed height to be viewport-based and responsive */
            height: 30vh;
            min-height: 250px; 
            max-height: 300px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Changed padding to be viewport-based */
            padding: 0 5vw;
            /* Changed margins to be viewport-based */
            margin-bottom: 8vh;
            margin-top: 8vh;
        }

        #bubble-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            filter: url('#gooey');
        }

        .fish-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .fish {
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        .fish-left {
            animation-delay: 0s;
        }

        .fish-right {
            animation-delay: 1.5s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(-2deg); }
            50% { transform: translateY(-5px) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(2deg); }
        }

        .fish svg {
            /* Made fish size responsive with min/max */
            width: 20vw;
            max-width: 100px;
            min-width: 60px;
            height: auto;
        }

        .fish-label {
            color: #000000;
            /* Made font size responsive */
            font-size: clamp(14px, 2.5vw, 18px);
            font-weight: 600;
            text-align: center;
        }

        .button-container {
            position: absolute;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            /* Added flex to handle multiple buttons */
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
            max-width: 90%;
        }

        .speak-button {
            /* Made padding responsive */
            padding: clamp(10px, 1.5vh, 12px) clamp(20px, 3vw, 28px);
            /* Made font size responsive */
            font-size: clamp(12px, 2vw, 15px);
            font-weight: 600;
            color: white;
            background: #209cee;
            border: 2px solid #209cee;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap; /* Prevents text from wrapping on small screens */
        }

        /* Style for the new "click" button */
        #clickBtn {
            background: #28a745;
            border-color: #28a745;
        }

        .speak-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .speak-button:active {
            transform: translateY(0);
        }

        .speak-button.recording {
            background: #d9534f; /* Red color for recording */
            border-color: #d9534f;
        }

        .bubble {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.95), rgba(100, 200, 255, 0.7));
            /* Made bubble size responsive */
            width: clamp(20px, 4vw, 30px);
            height: clamp(20px, 4vw, 30px);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }

        .bubble::before {
            content: '';
            position: absolute;
            /* Scaled pseudo-elements relative to bubble size */
            top: 16%;
            left: 20%;
            width: 26%;
            height: 26%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(1px);
        }

        .bubble::after {
            content: '';
            position: absolute;
            /* Scaled pseudo-elements relative to bubble size */
            top: 50%;
            left: 40%;
            width: 13%;
            height: 13%;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            filter: blur(0.5px);
        }

        .mic-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            flex-shrink: 0; /* Prevents icon from shrinking */
        }
        
        /* Fish swim animations (unchanged) */
        #blue-fish-rect { animation: swim-rect-blue 3s ease-in-out infinite alternate; }
        #blue-fish-path-b5e2ff { animation: swim-b5-blue 3s ease-in-out infinite alternate; }
        #blue-fish-path-236e9f { animation: swim-23-blue 3s ease-in-out infinite alternate; }
        #blue-fish-eye-group { animation: swim-eye-blue 3s ease-in-out infinite alternate; }
        #blue-fish-path-c3ccff { animation: swim-c3-blue 3s ease-in-out infinite alternate; }
        #blue-fish-path-45a2de { animation: swim-45-blue 3s ease-in-out infinite alternate; }
        
        #yellow-fish-rect { animation: swim-rect-yellow 3s ease-in-out infinite alternate; }
        #yellow-fish-path-b5e2ff { animation: swim-b5-yellow 3s ease-in-out infinite alternate; }
        #yellow-fish-path-236e9f { animation: swim-23-yellow 3s ease-in-out infinite alternate; }
        #yellow-fish-eye-group { animation: swim-eye-yellow 3s ease-in-out infinite alternate; }
        #yellow-fish-path-c3ccff { animation: swim-c3-yellow 3s ease-in-out infinite alternate; }
        #yellow-fish-path-45a2de { animation: swim-45-yellow 3s ease-in-out infinite alternate; }

        @keyframes swim-rect-blue {
          from { transform: none; }
          to { transform: translateX(-2px) scaleX(1.22); transform-origin: center; }
        }
        @keyframes swim-b5-blue {
          from { transform: none; }
          to { transform: translateX(-4px); }
        }
        @keyframes swim-23-blue {
          from { transform: none; }
          to { transform: translateX(4px); }
        }
        @keyframes swim-eye-blue {
          from { transform: none; }
          to { transform: translateX(-4px); }
        }
        @keyframes swim-c3-blue {
          from { transform: none; }
          to { transform: translateX(4px); }
        }
        @keyframes swim-45-blue {
          from { transform: none; }
          to { transform: translateX(2px) scaleX(0.96); transform-origin: center; }
        }
        
        @keyframes swim-rect-yellow {
          from { transform: none; }
          to { transform: translateX(2px) scaleX(1.22); transform-origin: center; }
        }
        @keyframes swim-b5-yellow {
          from { transform: none; }
          to { transform: translateX(4px); }
        }
        @keyframes swim-23-yellow {
          from { transform: none; }
          to { transform: translateX(-4px); }
        }
        @keyframes swim-eye-yellow {
          from { transform: none; }
          to { transform: translateX(4px); }
        }
        @keyframes swim-c3-yellow {
          from { transform: none; }
          to { transform: translateX(-4px); }
        }
        @keyframes swim-45-yellow {
          from { transform: none; }
          to { transform: translateX(-2px) scaleX(0.96); transform-origin: center; }
        }
    </style>
</head>
<body>

    <svg class="svg-filters" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <defs>
        <filter id="gooey">
          <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feBlend in="SourceGraphic" in2="goo" />
        </filter>
      </defs>
    </svg>

    <div class="container">
        <div id="bubble-container"></div>
    
        <div class="fish-wrapper">
            <div class="fish fish-left">
                <svg xmlns="http://www.w3.org/2000/svg" width="82" height="86" viewBox="0 0 82 86" fill="none">
                    <path id="blue-fish-path-236e9f" d="M61.0597 75.7005L65.1345 71.5157C69.7338 66.7923 69.6737 59.2468 64.9998 54.5973L60.8023 50.4218C58.4055 48.0374 54.5327 48.0375 52.1359 50.4218L51.9107 50.6458C49.6203 52.9243 49.6203 56.6311 51.9107 58.9096C54.2012 61.1881 54.1923 64.9038 51.9019 67.1823C49.6016 69.4706 49.5927 73.2023 51.893 75.4905L52.1752 75.7713C54.6405 78.2238 58.6337 78.1919 61.0597 75.7005Z" fill="#236E9F"/>
                    <path id="blue-fish-path-c3ccff" d="M19.0597 62.7004L23.1345 58.5156C27.7338 53.7922 27.6737 46.2467 22.9998 41.5972L18.8023 37.4217C16.4055 35.0374 12.5327 35.0374 10.1359 37.4217L9.9107 37.6457C7.62027 39.9242 7.62029 43.6311 9.91073 45.9096C12.2012 48.188 12.1923 51.9037 9.90186 54.1822C7.6016 56.4705 7.59268 60.2022 9.89296 62.4905L10.1752 62.7712C12.6405 65.2237 16.6337 65.1919 19.0597 62.7004Z" fill="#C3CCFF"/>
                    <path id="blue-fish-path-b5e2ff" d="M50.0597 79.7005L54.1345 75.5157C58.7338 70.7923 58.6737 63.2468 53.9998 58.5973L49.8023 54.4218C47.4055 52.0374 43.5327 52.0375 41.1359 54.4218L40.9107 54.6458C38.6203 56.9243 38.6203 60.6311 40.9107 62.9096C43.2012 65.1881 43.1923 68.9038 40.9019 71.1823C38.6016 73.4706 38.5927 77.2023 40.893 79.4905L41.1752 79.7713C43.6405 82.2238 47.6337 82.1919 50.0597 79.7005Z" fill="#B5E2FF"/>
                    <path id="blue-fish-path-45a2de" d="M34.1629 15.5614L38.3477 11.4866C43.0711 6.88731 50.6166 6.94743 55.2661 11.6213L59.4416 15.8188C61.8259 18.2156 61.8259 22.0884 59.4416 24.4852L59.2175 24.7104C56.939 27.0008 53.2322 27.0008 50.9537 24.7104C48.6752 22.4199 44.9595 22.4288 42.681 24.7192C40.3927 27.0195 36.6611 27.0284 34.3728 24.7281L34.0921 24.4459C31.6396 21.9806 31.6714 17.9874 34.1629 15.5614Z" fill="#45A2DE"/>
                    <ellipse cx="49" cy="45" rx="27" ry="27" transform="rotate(90 49 45)" fill="url(#paint0_linear_484_1043)"/>
                    <rect id="blue-fish-rect" x="82" y="32" width="27" height="9" rx="4.5" transform="rotate(90 82 32)" fill="#8392CD"/>
                    <g id="blue-fish-eye-group">
                        <circle cx="55" cy="45" r="15" transform="rotate(90 55 45)" fill="#EAF7FF"/>
                        <ellipse cx="57.4281" cy="44.2599" rx="9.5065" ry="9.50649" transform="rotate(90 57.4281 44.2599)" fill="black"/>
                        <ellipse cx="60.4757" cy="40.4561" rx="3.16883" ry="3.16883" transform="rotate(90 60.4757 40.4561)" fill="#EAF7FF"/>
                    </g>
                    <defs>
                        <linearGradient id="paint0_linear_484_1043" x1="29.5" y1="26" x2="76" y2="45" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#C1DEF6"/>
                        <stop offset="1" stop-color="#64ADEB"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="fish-label">You</div>
        </div>

        <div class="button-container">
            <button class="speak-button" id="micBtn">
                <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                Speak
            </button>
            <button class="speak-button" id="clickBtn">
                Click to Speak
            </button>
        </div>

        <div class="fish-wrapper">
            <div class="fish fish-right">
                <svg xmlns="http://www.w3.org/2000/svg" width="82" height="86" viewBox="0 0 82 86" fill="none" style="transform: scaleX(-1);">
                    <path id="yellow-fish-path-236e9f" d="M61.0597 75.7005L65.1345 71.5157C69.7338 66.7923 69.6737 59.2468 64.9998 54.5973L60.8023 50.4218C58.4055 48.0374 54.5327 48.0375 52.1359 50.4218L51.9107 50.6458C49.6203 52.9243 49.6203 56.6311 51.9107 58.9096C54.2012 61.1881 54.1923 64.9038 51.9019 67.1823C49.6016 69.4706 49.5927 73.2023 51.893 75.4905L52.1752 75.7713C54.6405 78.2238 58.6337 78.1919 61.0597 75.7005Z" fill="#F39C12"/>
					<path id="yellow-fish-path-c3ccff" d="M19.0597 62.7004L23.1345 58.5156C27.7338 53.7922 27.6737 46.2467 22.9998 41.5972L18.8023 37.4217C16.4055 35.0374 12.5327 35.0374 10.1359 37.4217L9.9107 37.6457C7.62027 39.9242 7.62029 43.6311 9.91073 45.9096C12.2012 48.188 12.1923 51.9037 9.90186 54.1822C7.6016 56.4705 7.59268 60.2022 9.89296 62.4905L10.1752 62.7712C12.6405 65.2237 16.6337 65.1919 19.0597 62.7004Z" fill="#FFF9E6"/>
                    <path id="yellow-fish-path-b5e2ff" d="M50.0597 79.7005L54.1345 75.5157C58.7338 70.7923 58.6737 63.2468 53.9998 58.5973L49.8023 54.4218C47.4055 52.0374 43.5327 52.0375 41.1359 54.4218L40.9107 54.6458C38.6203 56.9243 38.6203 60.6311 40.9107 62.9096C43.2012 65.1881 43.1923 68.9038 40.9019 71.1823C38.6016 73.4706 38.5927 77.2023 40.893 79.4905L41.1752 79.7713C43.6405 82.2238 47.6337 82.1919 50.0597 79.7005Z" fill="#FFF5CC"/>
                    <path id="yellow-fish-path-45a2de" d="M34.1629 15.5614L38.3477 11.4866C43.0711 6.88731 50.6166 6.94743 55.2661 11.6213L59.4416 15.8188C61.8259 18.2156 61.8259 22.0884 59.4416 24.4852L59.2175 24.7104C56.939 27.0008 53.2322 27.0008 50.9537 24.7104C48.6752 22.4199 44.9595 22.4288 42.681 24.7192C40.3927 27.0195 36.6611 27.0284 34.3728 24.7281L34.0921 24.4459C31.6396 21.9806 31.6714 17.9874 34.1629 15.5614Z" fill="#F4D03F"/>
                    <ellipse cx="49" cy="45" rx="27" ry="27" transform="rotate(90 49 45)" fill="url(#paint0_linear_yellow_new)"/>
                    <rect id="yellow-fish-rect" x="82" y="32" width="27" height="9" rx="4.5" transform="rotate(90 82 32)" fill="#F5B041"/>
                    <g id="yellow-fish-eye-group">
                        <circle cx="55" cy="45" r="15" transform="rotate(90 55 45)" fill="#FFF9E6"/>
                        <ellipse cx="57.4281" cy="44.2599" rx="9.5065" ry="9.50649" transform="rotate(90 57.4281 44.2599)" fill="black"/>
                        <ellipse cx="60.4757" cy="40.4561" rx="3.16883" ry="3.16883" transform="rotate(90 60.4757 40.4561)" fill="#FFF9E6"/>
                    </g>
                    <defs>
                        <linearGradient id="paint0_linear_yellow_new" x1="29.5" y1="26" x2="76" y2="45" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#FFF5CC"/>
                        <stop offset="1" stop-color="#F4D03F"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="fish-label">Receiver</div>
        </div>
    </div>

    <script>
        const micBtn = document.getElementById('micBtn');
        const clickBtn = document.getElementById('clickBtn'); // Get the new button
        const bubbleContainer = document.getElementById('bubble-container');
        
        let isRecording = false;

        // --- AudioContext variables for sound detection ---
        let audioContext;
        let analyser;
        let dataArray;
        let source;
        let stream;
        let animationFrameId;
        let wasSpeaking = false;
        const THRESHOLD = 20; // Sensitivity for sound detection. Lower is more sensitive.

        // --- New Button: Click to create bubble ---
        clickBtn.addEventListener('click', createBubble);

        // --- Mic Button: Click to detect sound ---
        micBtn.addEventListener('click', async () => {
            if (isRecording) {
                stopRecording();
            } else {
                // We await startRecording which handles permissions
                await startRecording();
            }
        });

        async function startRecording() {
            try {
                // 1. Get permissions and audio stream
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Set up AudioContext and Analyser
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // Smaller size for faster analysis
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                source.connect(analyser);
                
                // 3. Update UI and state
                isRecording = true;
                wasSpeaking = false; // Reset speaking state
                micBtn.classList.add('recording');
                micBtn.innerHTML = `
                    <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    Listening...
                `;
                
                // 4. Start the sound detection loop
                detectSound();

            } catch (err) {
                // Handle errors (permissions denied, no mic)
                console.error("Microphone access error:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert('Permission Denied: You must allow microphone access to use this feature.');
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    alert('No microphone was found. Please make sure one is connected.');
                } else {
                    alert('Could not access the microphone. Error: ' + err.message);
                }
                // Ensure we reset the state if starting failed
                stopRecording();
            }
        }

        function stopRecording() {
            isRecording = false;
            wasSpeaking = false;
            
            // 1. Stop the animation loop
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // 2. Stop the microphone stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // 3. Close the AudioContext
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // 4. Clean up variables
            analyser = null;
            source = null;
            dataArray = null;

            // 5. Reset button UI
            micBtn.classList.remove('recording');
            micBtn.innerHTML = `
                <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                Speak
            `;
        }

        // This function runs on every animation frame while recording
        function detectSound() {
            if (!isRecording || !analyser) return; // Stop if not recording

            animationFrameId = requestAnimationFrame(detectSound);
            
            // Get frequency data
            analyser.getByteFrequencyData(dataArray);
            
            // Calculate average volume
            const sum = dataArray.reduce((a, b) => a + b, 0);
            const avg = sum / dataArray.length;

            // Check if volume is above threshold
            if (avg > THRESHOLD && !wasSpeaking) {
                // If we detect a *new* sound, create a bubble
                createBubble();
                wasSpeaking = true; // Mark as "speaking" to avoid a stream of bubbles
            } else if (avg < THRESHOLD && wasSpeaking) {
                // Once the sound dips, reset the flag so we can detect the *next* sound
                wasSpeaking = false;
            }
        }


        function createBubble() {
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            const duration = (Math.random() * 1.5 + 2.5).toFixed(2);
            
            // --- Responsive Positions (using %) ---
            // Top position: random value between 35% and 55% of the container height
            const startTop = (45 + Math.random() * 10).toFixed(2); // 45-55%
            const midTop = (35 + Math.random() * 20).toFixed(2);   // 35-55%
            const endTop = (45 + Math.random() * 10).toFixed(2);     // 45-55%
            
            // Left position: fixed percentages to align with fish
            const startLeft = 18; // 18% from left
            const endLeft = 82;   // 82% from left

            const keyframeName = `shoot_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            
            const styleSheet = document.createElement('style');
            // Updated keyframes to use % for responsive positioning
            styleSheet.innerHTML = `
                @keyframes ${keyframeName} {
                    0% { 
                        left: ${startLeft}%; 
                        top: ${startTop}%; 
                        opacity: 0; 
                        transform: scale(0.3); 
                    }
                    10% { 
                        opacity: 1; 
                        transform: scale(1); 
                    }
                    50% { 
                        top: ${midTop}%; 
                        opacity: 1; 
                    }
                    100% { 
                        left: ${endLeft}%; 
                        top: ${endTop}%; 
                        opacity: 0; 
                        transform: scale(0.3); 
                    }
                }
            `;
            document.head.appendChild(styleSheet);
            
            bubble.style.animation = `${keyframeName} ${duration}s ease-in-out forwards`;
            
            bubbleContainer.appendChild(bubble);

            // Clean up the bubble and its stylesheet after the animation
            setTimeout(() => {
                if (bubble) bubble.remove();
                if (styleSheet) styleSheet.remove();
            }, duration * 1000);
        }
    </script>
</body>
</html>
